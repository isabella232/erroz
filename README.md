## erroz

_Erroz ramazotti the way you like it._

__Create abstract errors with meta-data, stack-traces and speaking error-messages.__

[![Build Status](https://travis-ci.org/peerigon/erroz.svg?branch=master)](https://travis-ci.org/peerigon/erroz)

Managing errors can be quite complicated. Parsing error messages is not ideal and adding some meta data to your `err` makes your code messy. Enter _erroz_! 

__erroz__ helps you with... 
- consistent error formats
- meta data for your errors (like http status-codes) 
- templated error messages
- optional stack traces
- optional [JSend](http://labs.omniti.com/labs/jsend) format

## Installation
[![npm status](https://nodei.co/npm/erroz.png?downloads=true&stars=true)](https://npmjs.org/package/erroz)

`npm install erroz`

### Options 

__renderMessage__ 

A custom template renderer in the form

```javascript 
function(data, message) { 
	return ""; 
}
```

__includeStack__

Should the stack be included in errors? Defaults to true. 
You migth wanna turn that off in production and send it to your logger instead. 

### Usage



#### Definition 
```javascript
var DuplicateError = erroz({
    name: "Duplicate",
    code: "duplicate",
    status: "fail",
    statusCode: 409,
    template: "Resource %resource (%id) already exists"
});
```

#### Throwing
```javascript
throw new DuplicateError({ resource: "Unicorn", id: 1 });

/*
 throw new DuplicateError();
 ^
 Duplicate: Resource Unicorn (1) already exists
 at Object.<anonymous> (/erroz/examples/staticErrorMessage.js:14:7)
 at Module._compile (module.js:456:26)
 at Object.Module._extensions..js (module.js:474:10)
 at Module.load (module.js:356:32)
 at Function.Module._load (module.js:312:12)
 at Function.Module.runMain (module.js:497:10)
 at startup (node.js:119:16)
 at node.js:902:3
 */
```
  
#### toJSON()
You can convert your errors to `JSON`. erroz does not overwrite the `toJSON` on default, so you will simply get all attributes. 

```javascript 
var err = new DuplicateError({ resource: "Unicorn", id: 1 });

JSON.stringify(err);

/*
 {
    "name":"Duplicate",
    "code":"duplicate",
    "status":"fail",
    "statusCode":409,
    "template":"Resource %resource (%id) already exists",
    "data":{
        "resource":"Unicorn",
        "id":1
    },
    "message":"Resource Unicorn (1) already exists"
 }
 */
```

__Custom JSON format__ 

By defining a `toJSON` function on erroz` AbstractError you can customize the JSON-format.

```javascript
//provide a custom `toJSON` method for all inherited errors
erroz.AbstractError.prototype.toJSON = function() {
    return {
        name: this.name,
        code: this.code
    };
};
```

would result in the following... 

```javascript
JSON.stringify(err);

/*
 {
    "name": "Duplicate",
    "code": "duplicate"
 }
 */
```
 
#### toJSend()
`toJSend()` can be used to convert your error in a JSend-style object to be used by your API.
Simply pass it to `res.send(err.toJSend());`. 
 
```javascript
var err = new DuplicateError({ resource: "Unicorn", id: 1 });

err.toJSend();

 {
    "status":"fail",
    "code":"duplicate",
    "message":"Resource Unicorn (1) already exists",
    "data":{
    	"resource":"Unicorn",
    	"id":1,
    	"stack":"Duplicate: Resource Unicorn (1) already exists\n    at Object.<anonymous> (/erroz/examples/				  toJson.js:13:11)\n    at Module._compile (module.js:				  456:26)\n    at Object.Module._extensions..js (module.js:474:10)\n    at Module.load 				  (module.js:356:32)\n    at Function.Module._load (module.js:312:12)\n    at 			     Function.Module.runMain (module.js:497:10)\n    at startup (node.js:119:16)\n    at node.js:				  906:3"
    	}
}
```

_PRO TIP_: Define a global error handler which does to `toJSend()` call and some logging. So you can simply `next` your errors in your route-handlers 

```javascript
function myAwesomeRoute(req, res, next) {
   if(!req.awesome) {
      next(new NotAwesomeError()); 
      return; 
   }
   
   next();
}	
```

```javascript
function globalErrozHandler(err, req, res, next) {
	
	//TODO great location for a logger! 
	
	if(err.toJSend) {
      res.send(err.toJSend()); 
      return; 
	} 
	
	//pass on all non-erroz errors
	next(err);
}
```

#### Error Messages
##### Templated

By setting a `template` property you can define a dynamic-error-message.
The _message_ will be generated by rendering the `template` with an object passed on Error construction. i.e. `new Error({ resource: "User" });` 

```javascript

var erroz = require("erroz");

var NotFoundError = erroz({
    name: "NotFound",
    code: "not-found",
    status: "fail",
    statusCode: 404,
    template: "%resource (%id) not found"
});

throw new NotFoundError({ resource: "User", id: 1 });

/*
/erroz/examples/customTemplateRenderer.js:22
 throw new NotFoundError({ resource: "User", id: 1 });
       ^
 NotFound: User (1) not found
     at Object.<anonymous> (/erroz/examples/customTemplateRenderer.js:22:7)
     at Module._compile (module.js:456:26)
     at Object.Module._extensions..js (module.js:474:10)
     at Module.load (module.js:356:32)
     at Function.Module._load (module.js:312:12)
     at Function.Module.runMain (module.js:497:10)
     at startup (node.js:119:16)
     at node.js:906:3
*/
```

You can also define a _custom error-renderer_: 

```javascript
//define custom renderer 
erroz.options.renderMessage = function(template, data) {
    return "Something went wrong with " + data.resource + " (" + data.id + ")";
};
```

```javascript 
/*
 throw new NotFoundError({ resource: "User", id: 1 });
 ^
 NotFound: Something went wrong with User (1)
```

##### Static

By setting a `message` property you can define a static error message. 

```javascript
var DuplicateError = erroz({
    name: "Duplicate",
    code: "duplicate",
    status: "fail",
    statusCode: 409,
    message: "Resource already exists"
});

throw new DuplicateError();

/*
 throw new DuplicateError();
 ^
 Duplicate: Resource already exists
 at Object.<anonymous> (/erroz/examples/staticErrorMessage.js:14:7)
 at Module._compile (module.js:456:26)
 at Object.Module._extensions..js (module.js:474:10)
 at Module.load (module.js:356:32)
 at Function.Module._load (module.js:312:12)
 at Function.Module.runMain (module.js:497:10)
 at startup (node.js:119:16)
 at node.js:902:3
 */
 ```